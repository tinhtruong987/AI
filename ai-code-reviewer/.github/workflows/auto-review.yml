name: ü§ñ Auto Review Pull Request

# Khi n√†o workflow n√†y ch·∫°y
on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Ch·ªâ ch·∫°y cho AI code reviewer (tr√°nh loop)
    paths:
      - "ai-code-reviewer/**"

# Quy·ªÅn c·∫ßn thi·∫øt cho workflow
permissions:
  contents: read
  pull-requests: write
  checks: read
  issues: write

jobs:
  auto-review:
    name: ü§ñ AI Code Review
    runs-on: ubuntu-latest

    # Ch·ªâ ch·∫°y n·∫øu kh√¥ng ph·∫£i bot t·∫°o PR (tr√°nh infinite loop)
    if: github.actor != 'github-actions[bot]'

    steps:
      # 1. Checkout code t·ª´ repository
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          # L·∫•y to√†n b·ªô history ƒë·ªÉ so s√°nh changes
          fetch-depth: 0

      # 2. Setup Node.js environment
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "ai-code-reviewer/package-lock.json"

      # 3. Install dependencies
      - name: üì• Install dependencies
        working-directory: ./ai-code-reviewer
        run: npm ci

      # 4. Run auto-review
      - name: ü§ñ Run AI Auto Review
        working-directory: ./ai-code-reviewer
        env:
          # GitHub t·ª± ƒë·ªông cung c·∫•p GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # API keys t·ª´ repository secrets
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          # GitHub Actions context
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: npm run auto-review-action

      # 5. Upload logs n·∫øu c√≥ l·ªói (for debugging)
      - name: üìã Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: auto-review-logs
          path: ai-code-reviewer/logs/
          retention-days: 7
